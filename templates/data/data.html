{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/css/data.css" />
<!-- Bootstrap 5 CSS (only for data page) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<div class="data-container">
    <div class="data-header">
        <h1><span id="collection-name">{{ collection_name or 'Data catalog' }}</span></h1>
        <p class="data-subtitle">Explore datasets generated or used in <span id="collection-name-sub">{{ collection_name }} and hosted on BioStudies archive.</span></p>
    </div>

    <nav class="navbar navbar-expand-lg bg-body-tertiary mb-3 d-inline">
        <form method="GET" action="{{ url_for('data') }}" class="d-flex" role="search">
            <input type="text" class="form-control me-2" name="query" id="search-input" value="{{ search_query or '' }}" placeholder="Search for datasets (e.g., S-ONTX26, toxicity, liver...)" />
            <div class="btn-group" role="group" aria-label="Search and filter buttons">
                <button type="submit" class="btn btn-outline-primary">Search</button>
                <a href="{{ url_for('data') }}" class="btn btn-outline-primary text-nowrap">All datasets</a>
                <button type="button" id="filter-toggle-btn" class="btn btn-outline-secondary">Filters</button>
            </div>
        </form>
        
        <!-- Filter Panel -->
        <div id="filter-panel" class="card bg-secondary-subtle p-3 mt-2" style="display: none;">
            <div class="filter-dropdowns">
                <!-- Case Study Dropdown -->
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Case Study
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-filter-type="case-study" data-filter-value="Thyroid">Thyroid</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="case-study" data-filter-value="Kidney">Kidney</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="case-study" data-filter-value="Parkinson">Parkinson</a></li>
                    </ul>
                </div>
                
                <!-- Flow Step Dropdown -->
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Flow Step
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="ADME">ADME</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="Chemical Information">Chemical Information</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="General">General</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="Hazard Assessment">Hazard Assessment</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="external exposure">External exposure</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="generic">Generic</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="flow-step" data-filter-value="Other">Other</a></li>
                    </ul>
                </div>
                
                <!-- Regulatory Questions Dropdown -->
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Regulatory Question
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Kidney Case Study (a)">Kidney Case Study (a)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Kidney Case Study (b)">Kidney Case Study (b)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Parkinson Case Study (a)">Parkinson Case Study (a)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Parkinson Case Study (b)">Parkinson Case Study (b)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Thyroid Case Study (a)">Thyroid Case Study (a)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter-type="reg-question" data-filter-value="Thyroid Case Study (b)">Thyroid Case Study (b)</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Selected Filters Display -->
            <div id="selected-filters" class="card p-2 align-content-center" style="display: none;">
                <span class="filter-label">Selected Filters:</span>
                <div id="filter-tags" class="filter-tags"></div>
            </div>
            
            <div class="filter-buttons">
                <button id="apply-filter-btn" class="btn btn-primary">Apply</button>
                <button id="clear-filter-btn" class="btn btn-outline-danger">Clear</button>
            </div>
        </div>
        
        <div id="search-status" class="search-status"></div>
    </nav>

    <!-- Pagination controls -->
    <div class="justify-content-between d-flex my-3 ">
        
        <a href="{{ url_for('data', page=page-1, page_size=page_size, query=search_query) }}" class="btn btn-sm btn-secondary {% if not has_prev %} disabled {% endif %}">Previous</a>
        
        <span class="d-inline">Page {{ page }} | Showing {{ studies|length }} of {{ total }} studies</span>
        
        {% if has_next %}
            <a href="{{ url_for('data', page=page+1, page_size=page_size, query=search_query) }}" class="btn btn-sm btn-secondary">Next</a>
        {% endif %}
    </div>

    <div class="results-section">
        <div id="results-list" class="results-list">
            {% if error %}
                <div class="alert alert-warning">{{ error }}</div>
            {% elif studies %}
                <!-- Server-rendered studies -->
                {% for study in studies %}
                <div class="card p-0 mb-0" data-accession="{{ study.accession or study.accno }}">
                    <div class="card-header justify-content-between d-flex">
                        <span class="result-accession">{{ study.accession or study.accno }}</span>
                        <span class="badge bg-primary-subtle text-secondary rounded-pill align-content-center">{{ study.type or 'unknown' }}</span>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" style="word-break: break-word;">
                            {{ study.title or 'Untitled Study' }}
                        </h5>
                        <div class="card-text">
                            <span class="text-secondary">Released: {{ study.release_date or study.rdate or 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-0 py-3">
                            <a href="{{ study.url or '#' }}" class="btn btn-outline-primary d-inline" target="_blank"><i class="bi bi-box-arrow-up-right pe-1"></i> View in BioStudies</a>
                            <a href="#" class="btn btn-outline-secondary d-inline view-details-btn"><i class="bi bi-box-fill pe-1"></i> RO-Crate</a>
                    </div>
                </div>
                {% endfor %}
            
            {% else %}
                <div class="alert alert-warning">No studies found</div>
            {% endif %}
        </div>

        
        <!-- Loading indicator for infinite scroll (kept for potential AJAX use) -->
        <div id="loading-indicator" class="text-center my-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading more studies...</p>
        </div>
        
        <div id="study-detail" class="study-detail" style="display: none;">
            <button id="back-btn" class="btn btn-back">← Back to Results</button>
            <div id="study-content"></div>
        </div>
    </div>
</div>

<script>
    // Define API_BASE if not already defined
    const API_BASE = window.API_BASE || '/api';

    // Filter functionality
    const filterToggleBtn = document.getElementById('filter-toggle-btn');
    const filterPanel = document.getElementById('filter-panel');
    const applyFilterBtn = document.getElementById('apply-filter-btn');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const selectedFiltersContainer = document.getElementById('selected-filters');
    const filterTagsContainer = document.getElementById('filter-tags');
    const resultsListContainer = document.getElementById('results-list');
    const searchStatusContainer = document.getElementById('search-status');
    let allStudies = []; // Store all studies for filtering
    let selectedFilters = {
        'case-study': [],
        'flow-step': [],
        'reg-question': []
    };

    // Helper function to display results
    function displayResults(studies, totalCount) {
        if (!resultsListContainer) return;
        
        if (studies.length === 0) {
            resultsListContainer.innerHTML = '<div class="alert alert-warning">No studies found</div>';
            return;
        }
        
        // For now, just show a message since we're filtering server-rendered content
        console.log(`Would display ${studies.length} of ${totalCount} studies`);
    }

    // Helper function to show status messages
    function showStatus(message, type = 'info') {
        if (!searchStatusContainer) return;
        
        searchStatusContainer.textContent = message;
        searchStatusContainer.className = `search-status ${type}`;
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                searchStatusContainer.textContent = '';
                searchStatusContainer.className = 'search-status';
            }, 3000);
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        filterToggleBtn.addEventListener('click', () => {
            const isVisible = filterPanel.style.display !== 'none';
            filterPanel.style.display = isVisible ? 'none' : 'block';
            filterToggleBtn.textContent = isVisible ? 'Filters' : 'Filters';
        });

        // Add click handlers for dropdown items
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const filterType = e.target.dataset.filterType;
                const filterValue = e.target.dataset.filterValue;
                addFilter(filterType, filterValue);
            });
        });
    });

    function addFilter(type, value) {
        // Prevent duplicates
        if (selectedFilters[type].includes(value)) {
            return;
        }
        
        selectedFilters[type].push(value);
        updateFilterDisplay();
    }

    function removeFilter(type, value) {
        selectedFilters[type] = selectedFilters[type].filter(v => v !== value);
        updateFilterDisplay();
    }

    function updateFilterDisplay() {
        // Clear current tags
        filterTagsContainer.innerHTML = '';
        
        // Count total filters
        const totalFilters = selectedFilters['case-study'].length + 
                           selectedFilters['flow-step'].length + 
                           selectedFilters['reg-question'].length;
        
        // Show/hide container
        if (totalFilters === 0) {
            selectedFiltersContainer.style.display = 'none';
            return;
        }
        
        selectedFiltersContainer.style.display = 'block';
        
        // Create tags for each filter
        Object.entries(selectedFilters).forEach(([type, values]) => {
            values.forEach(value => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.innerHTML = `
                    ${value}
                    <button class="filter-tag-remove" onclick="removeFilterTag('${type}', '${value}')">×</button>
                `;
                filterTagsContainer.appendChild(tag);
            });
        });
    }

    // Make removeFilter accessible globally for onclick handler
    window.removeFilterTag = function(type, value) {
        removeFilter(type, value);
    };

    applyFilterBtn.addEventListener('click', applyFilters);
    clearFilterBtn.addEventListener('click', clearFilters);

    async function applyFilters() {
        const caseStudyFilters = selectedFilters['case-study'];
        const flowStepFilters = selectedFilters['flow-step'];
        const regQuestionFilters = selectedFilters['reg-question'];
        
        const hasAnyFilter = caseStudyFilters.length > 0 || flowStepFilters.length > 0 || regQuestionFilters.length > 0;
        
        if (!hasAnyFilter) {
            displayResults(allStudies, allStudies.length);
            showStatus('Showing all studies', 'success');
            return;
        }
        
        showStatus('Applying filters...', 'loading');
        
        const filteredStudies = [];
        for (const study of allStudies) {
            try {
                const accession = study.accession || study.accno;
                const response = await fetch(`${API_BASE}/study/${accession}`);
                const metadata = await response.json();
                
                let matchesCaseStudy = caseStudyFilters.length === 0;
                let matchesFlowStep = flowStepFilters.length === 0;
                let matchesRegQuestion = regQuestionFilters.length === 0;
                
                if (caseStudyFilters.length > 0 && metadata.general_info && metadata.general_info['Case study']) {
                    const caseStudy = metadata.general_info['Case study'].value || metadata.general_info['Case study'];
                    matchesCaseStudy = caseStudyFilters.includes(caseStudy);
                }
                
                if (flowStepFilters.length > 0 && metadata.general_info && metadata.general_info['Flow step']) {
                    const flowStep = metadata.general_info['Flow step'].value || metadata.general_info['Flow step'];
                    matchesFlowStep = flowStepFilters.includes(flowStep);
                }
                
                if (regQuestionFilters.length > 0 && metadata.general_info && metadata.general_info['Regulatory questions']) {
                    const regQuestion = metadata.general_info['Regulatory questions'].value || metadata.general_info['Regulatory questions'];
                    matchesRegQuestion = regQuestionFilters.includes(regQuestion);
                }
                
                if (matchesCaseStudy && matchesFlowStep && matchesRegQuestion) {
                    filteredStudies.push(study);
                }
            } catch (error) {
                console.error('Error fetching study metadata:', error);
            }
        }
        
        const activeFilterCount = caseStudyFilters.length + flowStepFilters.length + regQuestionFilters.length;
        displayResults(filteredStudies, filteredStudies.length);
        showStatus(`Showing ${filteredStudies.length} studies matching ${activeFilterCount} selected filter(s)`, 'success');
    }

    function clearFilters() {
        selectedFilters = {
            'case-study': [],
            'flow-step': [],
            'reg-question': []
        };
        updateFilterDisplay();
        // Note: Filters currently only work with JavaScript-fetched data
        // To fully implement, would need server-side filter support
    }
</script>

{% endblock %}
